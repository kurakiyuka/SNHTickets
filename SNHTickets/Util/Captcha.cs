using System;
using System.Collections;
using System.Drawing;

namespace SNHTickets.Util
{
    public class Captcha
    {
        public Captcha()
        {

        }

        static Hashtable captchaDict = new Hashtable();
        public static void InitCaptchaDict()
        {
            // --1111--
            // -11--11-
            // 11----1-
            // 11------
            // 11-111--
            // 111--11-
            // 11----11
            // 11----11
            // -11--11-
            // --1111--
            //
            captchaDict.Add("--1111---11--11-11----1-11------11-111--111--11-11----1111----11-11--11---1111--", "6");

            // --1111--
            // -11--11-
            // 11----11
            // ------11
            // -----11-
            // ----11--
            // ---11---
            // --11----
            // -11-----
            // 11111111
            // 
            captchaDict.Add("--1111---11--11-11----11------11-----11-----11-----11-----11-----11-----11111111", "2");


            // 1111111-
            // 11----11
            // 11----11
            // 11----11
            // 1111111-
            // 11111---
            // 11--11--
            // 11---11-
            // 11----11
            // 11----11
            // 
            captchaDict.Add("1111111-11----1111----1111----111111111-11111---11--11--11---11-11----1111----11", "R");


            // 11----11
            // 11---11-
            // 11--11--
            // 11-11---
            // 1111----
            // 1111----
            // 11-11---
            // 11--11--
            // 11---11-
            // 11----11
            // 
            captchaDict.Add("11----1111---11-11--11--11-11---1111----1111----11-11---11--11--11---11-11----11", "K");


            // 1111111-
            // 11------
            // 11------
            // 11-111--
            // 111--11-
            // ------11
            // ------11
            // 11----11
            // -11--11-
            // --1111--
            // 
            captchaDict.Add("1111111-11------11------11-111--111--11-------11------1111----11-11--11---1111--", "5");


            // 11----11
            // 11----11
            // 11----11
            // 11----11
            // 11----11
            // 11----11
            // 11----11
            // 11----11
            // -11--11-
            // --1111--
            // 
            captchaDict.Add("11----1111----1111----1111----1111----1111----1111----1111----11-11--11---1111--", "U");


            // 11------
            // 11------
            // 11------
            // 11------
            // 11------
            // 11------
            // 11------
            // 11------
            // 11------
            // 1111111-
            // 
            captchaDict.Add("11------11------11------11------11------11------11------11------11------1111111-", "L");


            // -11111--
            // 11---11-
            // ------11
            // -----11-
            // ---111--
            // -----11-
            // ------11
            // ------11
            // 11---11-
            // -11111--
            // 
            captchaDict.Add("-11111--11---11-------11-----11----111-------11-------11------1111---11--11111--", "3");


            // 11111111
            // ---11---
            // ---11---
            // ---11---
            // ---11---
            // ---11---
            // ---11---
            // ---11---
            // ---11---
            // ---11---
            // 
            captchaDict.Add("11111111---11------11------11------11------11------11------11------11------11---", "T");


            // 11----11
            // 11----11
            // -11--11-
            // --1111--
            // ---11---
            // ---11---
            // --1111--
            // -11--11-
            // 11----11
            // 11----11
            // 
            captchaDict.Add("11----1111----11-11--11---1111-----11------11-----1111---11--11-11----1111----11", "X");


            // 1111111-
            // 11------
            // 11------
            // 11------
            // 111111--
            // 11------
            // 11------
            // 11------
            // 11------
            // 1111111-
            // 
            captchaDict.Add("1111111-11------11------11------111111--11------11------11------11------1111111-", "E");


            // 11111111
            // ------11
            // ------11
            // -----11-
            // ----11--
            // ---11---
            // --11----
            // -11-----
            // 11------
            // 11------
            // 
            captchaDict.Add("11111111------11------11-----11-----11-----11-----11-----11-----11------11------", "7");


            // --11111-
            // -11---11
            // 11-----1
            // 11------
            // 11------
            // 11------
            // 11------
            // 11-----1
            // -11---11
            // --11111-
            // 
            captchaDict.Add("--11111--11---1111-----111------11------11------11------11-----1-11---11--11111-", "C");


            // 11----11
            // 11----11
            // -11--11-
            // --1111--
            // ---11---
            // ---11---
            // ---11---
            // ---11---
            // ---11---
            // ---11---
            // 
            captchaDict.Add("11----1111----11-11--11---1111-----11------11------11------11------11------11---", "Y");


            // --11111-
            // -11---11
            // 11------
            // 11------
            // 11------
            // 11---111
            // 11----11
            // 11----11
            // -11---11
            // --11111-
            // 
            captchaDict.Add("--11111--11---1111------11------11------11---11111----1111----11-11---11--11111-", "G");


            // -111111-
            // 11----11
            // 11------
            // 11------
            // -111111-
            // ------11
            // ------11
            // ------11
            // 11----11
            // -111111-
            // 
            captchaDict.Add("-111111-11----1111------11-------111111-------11------11------1111----11-111111-", "S");


            // 1111111-
            // -----11-
            // -----11-
            // ----11--
            // ---11---
            // --11---1
            // -11-----
            // 11------
            // 11------
            // 1111111-
            // 
            captchaDict.Add("1111111------11------11-----11-----11-----11---1-11-----11------11------1111111-", "Z");


            // 111111--
            // 11---11-
            // 11----11
            // 11---11-
            // 111111--
            // 11---11-
            // 11----11
            // 11----11
            // 11---11-
            // 111111--
            // 
            captchaDict.Add("111111--11---11-11----1111---11-111111--11---11-11----1111----1111---11-111111--", "B");


            // 11----11
            // 11----11
            // 11----11
            // 11----11
            // 11-11-11
            // 11-11-11
            // 11-11-11
            // 11111111
            // 111--111
            // 11----11
            // 
            captchaDict.Add("11----1111----1111----1111----1111-11-1111-11-1111-11-1111111111111--11111----11", "W");


            // 11----11
            // 11----11
            // 11----11
            // 11----11
            // 11111111
            // 11----11
            // 11----11
            // 11----11
            // 11----11
            // 11----11
            // 
            captchaDict.Add("11----1111----1111----1111----111111111111----1111----1111----1111----1111----11", "H");


            // 11----11
            // 111---11
            // 1111--11
            // 1111--11
            // 11-11-11
            // 11-11-11
            // 11--1111
            // 11---111
            // 11---111
            // 11----11
            // 
            captchaDict.Add("11----11111---111111--111111--1111-11-1111-11-1111--111111---11111---11111----11", "N");


            // 1111111-
            // 11----11
            // 11----11
            // 11----11
            // 1111111-
            // 11------
            // 11------
            // 11------
            // 11------
            // 11------
            // 
            captchaDict.Add("1111111-11----1111----1111----111111111-11------11------11------11------11------", "P");


            // -----11-
            // ----111-
            // ---1111-
            // --11-11-
            // -11--11-
            // 11---11-
            // 11111111
            // -----11-
            // -----11-
            // -----11-
            // 
            captchaDict.Add("-----11-----111----1111---11-11--11--11-11---11-11111111-----11------11------11-", "4");


            // ---11---
            // --1111--
            // -11--11-
            // 11----11
            // 11----11
            // 11----11
            // 11111111
            // 11----11
            // 11----11
            // 11----11
            // 
            captchaDict.Add("---11-----1111---11--11-11----1111----1111----111111111111----1111----1111----11", "A");


            // 111111--
            // 11---11-
            // 11----11
            // 11----11
            // 11----11
            // 11----11
            // 11----11
            // 11----11
            // 11---11-
            // 111111--
            // 
            captchaDict.Add("111111--11---11-11----1111----1111----1111----1111----1111----1111---11-111111--", "D");


            // 1111111-
            // -----11-
            // -----11-
            // ----11--
            // ---11---
            // --11----
            // -11-----
            // 11------
            // 11------
            // 1111111-
            // 
            captchaDict.Add("1111111------11------11-----11-----11-----11-----11-----11------11------1111111-", "Z");


            // 11----11
            // 111--111
            // 11111111
            // 11-11-11
            // 11-11-11
            // 11-11-11
            // 11----11
            // 11----11
            // 11----11
            // 11----11
            // 
            captchaDict.Add("11----11111--1111111111111-11-1111-11-1111-11-1111----1111----1111----1111----11", "M");


            // 11111111
            // 11------
            // 11------
            // 11------
            // 111111--
            // 11------
            // 11------
            // 11------
            // 11------
            // 11------
            // 
            captchaDict.Add("1111111111------11------11------111111--11------11------11------11------11------", "F");


            // --1111--
            // -11--11-
            // 11----11
            // 11----11
            // 11----11
            // 11----11
            // 11-11-11
            // 11--1111
            // -11--11-
            // --1111-1
            // 
            captchaDict.Add("--1111---11--11-11----1111----1111----1111----1111-11-1111--1111-11--11---1111-1", "Q");


            // --1111--
            // -11--11-
            // 11----11
            // -11--11-
            // --1111--
            // -11--11-
            // 11----11
            // 11----11
            // -11--11-
            // --1111--
            // 
            captchaDict.Add("--1111---11--11-11----11-11--11---1111---11--11-11----1111----11-11--11---1111--", "8");


            // ---1111-
            // -----11-
            // -----11-
            // -----11-
            // -----11-
            // -----11-
            // -----11-
            // -1---11-
            // -11-11--
            // --111---
            // 
            captchaDict.Add("---1111------11------11------11------11------11------11--1---11--11-11----111---", "J");


            // 11----11
            // 11----11
            // 11----11
            // -11--11-
            // -11--11-
            // -11--11-
            // --1111--
            // --1111--
            // ---11---
            // ---11---
            // 
            captchaDict.Add("11----1111----1111----11-11--11--11--11--11--11---1111----1111-----11------11---", "V");


            // --1111--
            // -11--11-
            // 11----11
            // 11----11
            // -11--111
            // --111-11
            // ------11
            // -1----11
            // -11--11-
            // --1111--
            // 
            captchaDict.Add("--1111---11--11-11----1111----11-11--111--111-11------11-1----11-11--11---1111--", "9");

        }

        public static string BinaryChar(Bitmap captchaBitmap, int x_start, int x_end)
        {
            string retVal = "";
            if ((captchaBitmap.Height <= 5)
                || (x_start >= x_end)
                || (captchaBitmap.Width <= x_end))
            {
                return retVal;
            }

            for (int y = 5; y < captchaBitmap.Height - 5; y++)
            {
                for (int x = x_start; x <= x_end; x++)
                {
                    Color c = captchaBitmap.GetPixel(x, y);
                    if ((c.R >= 250 && c.G >= 250 && c.B >= 250)
                        || (c.R <= 5 && c.G <= 5 && c.B <= 5))
                    {
                        retVal += '1';
                    }
                    else
                    {
                        retVal += '-';
                    }
                }
            }

            return retVal;
        }

        public static string CaptchaToText(Bitmap captchaBitmap)
        {
            string retVal = "";
            string c1 = BinaryChar(captchaBitmap, 32, 39);
            string c2 = BinaryChar(captchaBitmap, 41, 48);
            string c3 = BinaryChar(captchaBitmap, 50, 57);
            string c4 = BinaryChar(captchaBitmap, 59, 66);

            if (captchaDict.Contains(c1)
                && captchaDict.Contains(c2)
                && captchaDict.Contains(c3)
                && captchaDict.Contains(c4))
            {
                retVal = (string)captchaDict[c1] + (string)captchaDict[c2] + (string)captchaDict[c3] + (string)captchaDict[c4];
            }

            return retVal;
        }
    }
}
